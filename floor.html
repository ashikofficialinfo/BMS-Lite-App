<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Floor Control</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">
  <h2 id="floorTitle">Floor X</h2>
  <div id="roomList"></div>
  <button class="logout" id="backBtn">Back to Dashboard</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCmRQY6Qkursb7kt4p_pizV747JO7EntDM",
  authDomain: "bms-lite-c1453.firebaseapp.com",
  databaseURL: "https://bms-lite-c1453-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "bms-lite-c1453",
  storageBucket: "bms-lite-c1453.firebasestorage.app",
  messagingSenderId: "992533228260",
  appId: "1:992533228260:web:89739abdfc5cef63ff9af1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Get floor number from URL
const urlParams = new URLSearchParams(window.location.search);
const floorNum = urlParams.get('floor');
document.getElementById('floorTitle').innerText = `Floor ${floorNum}`;

const floorRef = ref(db, `floors/${floorNum}`);
const roomList = document.getElementById('roomList');

onValue(floorRef, snapshot => {
  roomList.innerHTML = "";
  const rooms = snapshot.val();
  if(!rooms) return;

  Object.keys(rooms).forEach(room => {
    const roomData = rooms[room];
    const roomDiv = document.createElement('div');
    roomDiv.classList.add('room');

    const info = document.createElement('div');
    info.innerHTML = `<strong>${room}</strong> | Temp: <span id="${room}-temp">${roomData.temp}</span>Â°C`;
    roomDiv.appendChild(info);

    const btn = document.createElement('button');
    btn.innerText = roomData.fcu ? "ON" : "OFF";
    btn.onclick = () => { set(ref(db, `floors/${floorNum}/${room}/fcu`), !roomData.fcu); };
    roomDiv.appendChild(btn);

    roomList.appendChild(roomDiv);

    onValue(ref(db, `floors/${floorNum}/${room}/temp`), tempSnap => {
      document.getElementById(`${room}-temp`).innerText = tempSnap.val();
    });

    onValue(ref(db, `floors/${floorNum}/${room}/fcu`), fcuSnap => {
      btn.innerText = fcuSnap.val() ? "ON" : "OFF";
      roomData.fcu = fcuSnap.val();
    });
  });
});

// Back button
document.getElementById('backBtn').onclick = () => { window.location.href = "index.html"; };
</script>

</body>
</html>
